import os, requests
from datetime import datetime

TODOIST_TOKEN = os.environ.get("TODOIST_TOKEN")
if not TODOIST_TOKEN:
    raise SystemExit("Missing TODOIST_TOKEN in environment")

headers = {
    "Authorization": f"Bearer {TODOIST_TOKEN}",
    "Content-Type": "application/json",
}

today = datetime.now().date()
since = f"{today}T00:00:00"
until = f"{today}T23:59:59"

endpoints = [
    "https://api.todoist.com/rest/v1/completed/get_all",
    "https://api.todoist.com/api/v1/completed/get_all",
    "https://api.todoist.com/sync/v9/completed/get_all",
    "https://todoist.com/API/v9/completed/get_all",
    "https://api.todoist.com/rest/v1/completed",        # alternate form
    "https://api.todoist.com/api/v1/completed",         # alternate form
]

params = {"project_id": "6fxHrQ58f8jFXp24", "limit": 50, "since": since, "until": until}

for url in endpoints:
    try:
        r = requests.get(url, headers=headers, params=params, timeout=15)
    except Exception as e:
        print(f"URL: {url}\n  Exception: {e}\n")
        continue

    print("URL:", url)
    print("  Final request URL:", r.url)
    print("  Status:", r.status_code)
    text = r.text
    print("  Body preview:", text[:800].replace("\n", " ") if text else "<empty>")
    print("-" * 80)
