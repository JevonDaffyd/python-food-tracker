name: Diagnostic - Todoist endpoints

on:
  workflow_dispatch:

jobs:
  probe:
    runs-on: ubuntu-latest
    steps:
      - name: Run endpoint probes
        env:
          TODOIST_TOKEN: ${{ secrets.TODOIST_TOKEN }}
        run: |
          python - <<'PY'
          import os, requests
          from datetime import datetime
          token = os.environ.get("TODOIST_TOKEN")
          headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
          today = datetime.now().date()
          since = f"{today}T00:00:00"
          until = f"{today}T23:59:59"
          endpoints = [
            "https://api.todoist.com/rest/v1/completed/get_all",
            "https://api.todoist.com/api/v1/completed/get_all",
            "https://api.todoist.com/sync/v9/completed/get_all",
            "https://todoist.com/API/v9/completed/get_all",
            "https://api.todoist.com/rest/v1/completed",
            "https://api.todoist.com/api/v1/completed",
          ]
          params = {"project_id": "6fxHrQ58f8jFXp24", "limit": 50, "since": since, "until": until}
          for url in endpoints:
              try:
                  r = requests.get(url, headers=headers, params=params, timeout=15)
              except Exception as e:
                  print(f"URL: {url}\\n  Exception: {e}\\n")
                  continue
              print("URL:", url)
              print("  Final request URL:", r.url)
              print("  Status:", r.status_code)
              print("  Body preview:", (r.text or "")[:800].replace("\\n"," "))
              print("-"*60)
          PY
